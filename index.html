<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PR/TR Workshop Training</title>
<style>
:root{--bg:#f8fafc;--card:#ffffff;--muted:#f1f5f9;--text:#1e293b;--sub:#64748b;--brand:#3b82f6;--border:#e2e8f0;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;background:linear-gradient(180deg,#f1f5f9,#e2e8f0);color:var(--text)}
.container{max-width:1100px;margin:0 auto;padding:24px}h1{font-size:24px;margin:0 0 12px}h2{font-size:18px;margin:0 0 8px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.08);margin-bottom:12px}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.spacer{flex:1}
.btn{appearance:none;border:1px solid var(--border);background:var(--muted);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
.btn:hover{filter:brightness(0.95)}.btn.primary{background:var(--brand);border-color:transparent;color:#ffffff}.btn.ghost{background:transparent}.btn.danger{background:color-mix(in oklab,var(--bad) 15%,transparent);color:var(--bad)}
input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;background:#ffffff;border:1px solid var(--border);color:var(--text)}
label{font-size:12px;color:var(--sub);display:block;margin-bottom:6px}
.grid{display:grid;gap:10px}.g2{grid-template-columns:repeat(2,minmax(0,1fr))}.g3{grid-template-columns:repeat(3,minmax(0,1fr))}.g4{grid-template-columns:repeat(4,minmax(0,1fr))}.g5{grid-template-columns:repeat(5,minmax(0,1fr))}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}.tab-btn{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--muted);cursor:pointer}.tab-btn.active{background:var(--brand);color:#ffffff;border-color:transparent}
.table{width:100%;border-collapse:collapse}.table th,.table td{padding:8px;border-top:1px solid var(--border);text-align:left;vertical-align:top}.table th{color:var(--sub);font-weight:600}
.kpi{font-size:28px;font-weight:800}.help{color:var(--sub);font-size:13px}.badge{display:inline-block;padding:.15rem .5rem;border-radius:999px;font-size:12px;background:var(--muted);color:var(--text)}.pill{display:inline-block;width:28px;height:18px;border-radius:6px;margin-right:6px}
.center{display:flex;justify-content:center;align-items:center;min-height:50vh;text-align:center}
a.link{color:var(--brand);text-decoration:none}a.link:hover{text-decoration:underline}
footer{color:var(--sub);font-size:12px;margin-top:24px}
@media (max-width:900px){
  .g4{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g5{grid-template-columns:repeat(2,minmax(0,1fr))}
  .container{padding:12px}
  .tabs{flex-direction:column;gap:4px}
  .tab-btn{width:100%;text-align:center}
  .row{flex-direction:column;gap:8px}
  .spacer{display:none}
  .table{font-size:12px}
  .table th,.table td{padding:4px}
}
@media (max-width:600px){
  .g2{grid-template-columns:1fr}
  .g3{grid-template-columns:1fr}
  .g4{grid-template-columns:1fr}
  .g5{grid-template-columns:1fr}
  .kpi{font-size:20px}
  h1{font-size:20px}
  h2{font-size:16px}
}
</style>
</head>
<body>
<div class="container" id="app"></div>

<!-- Firebase (Compat SDK for simplest deploy) -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<script>
/* Simple authentication system */
const auth = {
  currentUser: null,
  signInWithEmailAndPassword: async (email, password) => {
    if (email === 'admin' && password === 'a123456') {
      auth.currentUser = { email: 'admin', displayName: 'Admin' };
      state.user = auth.currentUser; // Update global state
      localStorage.setItem('currentUser', JSON.stringify(auth.currentUser)); // Persist session
      return { user: auth.currentUser };
    }
    throw new Error('Invalid credentials');
  },
  createUserWithEmailAndPassword: async (email, password) => {
    if (email === 'admin' && password === 'a123456') {
      auth.currentUser = { email: 'admin', displayName: 'Admin' };
      state.user = auth.currentUser; // Update global state
      localStorage.setItem('currentUser', JSON.stringify(auth.currentUser)); // Persist session
      return { user: auth.currentUser };
    }
    throw new Error('Invalid credentials');
  },
  signOut: () => {
    auth.currentUser = null;
    state.user = null; // Update global state
    localStorage.removeItem('currentUser'); // Clear session
  },
  onAuthStateChanged: (callback) => {
    // Check localStorage for existing session
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      auth.currentUser = JSON.parse(savedUser);
      state.user = auth.currentUser;
    }
    setTimeout(() => callback(auth.currentUser), 100);
  }
};

/* Enhanced Mock Firestore with real-time updates */
const db = {
  listeners: {},
  collection: (name) => ({
    add: async (data) => {
      const id = Math.random().toString(36).substr(2, 9);
      const item = { _id: id, ...data };
      localStorage.setItem(`${name}_${id}`, JSON.stringify(item));
      // Trigger listeners
      db.triggerListeners(name);
      return { id };
    },
    doc: (id) => ({
      update: async (data) => {
        const existing = localStorage.getItem(`${name}_${id}`);
        if (existing) {
          const item = { ...JSON.parse(existing), ...data };
          localStorage.setItem(`${name}_${id}`, JSON.stringify(item));
          // Trigger listeners
          db.triggerListeners(name);
        }
      },
      delete: async () => {
        localStorage.removeItem(`${name}_${id}`);
        // Trigger listeners
        db.triggerListeners(name);
      }
    }),
    orderBy: (field) => ({
      onSnapshot: (callback) => {
        const listenerId = Math.random().toString(36).substr(2, 9);
        if (!db.listeners[name]) db.listeners[name] = [];
        db.listeners[name].push({ id: listenerId, callback, field });
        
        // Initial call
        const items = db.getCollectionItems(name, field);
        callback({ docs: items });
        
        // Return unsubscribe function
        return () => {
          if (db.listeners[name]) {
            db.listeners[name] = db.listeners[name].filter(l => l.id !== listenerId);
          }
        };
      }
    }),
    where: (field, op, value) => ({
      limit: (num) => ({
        get: async () => {
          const items = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith(`${name}_`)) {
              const item = JSON.parse(localStorage.getItem(key));
              if (item[field] === value) {
                items.push({ id: key.split('_')[1], data: () => item });
              }
            }
          }
          return { docs: items, empty: items.length === 0 };
        }
      })
    })
  }),
  batch: () => ({
    set: (ref, data) => {
      const id = Math.random().toString(36).substr(2, 9);
      localStorage.setItem(`tasks_${id}`, JSON.stringify({ _id: id, ...data }));
    },
    commit: async () => {
      // Trigger listeners after batch commit
      db.triggerListeners('tasks');
    }
  }),
  getCollectionItems: (name, field) => {
    const items = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith(`${name}_`)) {
        const item = JSON.parse(localStorage.getItem(key));
        items.push({ id: key.split('_')[1], data: () => item });
      }
    }
    // Sort by field if specified
    if (field) {
      items.sort((a, b) => {
        const aVal = a.data()[field] || '';
        const bVal = b.data()[field] || '';
        return aVal.localeCompare(bVal);
      });
    }
    return items;
  },
  triggerListeners: (name) => {
    if (db.listeners[name]) {
      db.listeners[name].forEach(listener => {
        const items = db.getCollectionItems(name, listener.field);
        listener.callback({ docs: items });
      });
    }
  }
};

/* Mock Firebase */
const firebase = {
  auth: () => auth,
  firestore: () => db,
  firestore: {
    FieldValue: {
      serverTimestamp: () => new Date().toISOString()
    }
  }
};

/* Email/Password + Google handlers (NO extra <script> here) */
document.addEventListener('click', async (e) => {
  if (e.target.id === 'loginEmail') {
    const em = document.getElementById('email').value.trim();
    const pw = document.getElementById('password').value;
    try { await auth.signInWithEmailAndPassword(em, pw); }
    catch (err) { alert('Sign-in failed: ' + err.message); }
  }
  if (e.target.id === 'registerEmail') {
    const em = document.getElementById('email').value.trim();
    const pw = document.getElementById('password').value;
    try { await auth.createUserWithEmailAndPassword(em, pw); }
    catch (err) { alert('Register failed: ' + err.message); }
  }
  if (e.target.id === 'googleBtn') {
    try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    catch (err) { alert('Google sign-in failed: ' + err.message); }
  }
});
</script>

<script>
/* Collections */
const col = { 
  techs: ()=>db.collection('technicians'), 
  tasks: ()=>db.collection('tasks'), 
  assess: ()=>db.collection('assessments'),
  teams: ()=>db.collection('teams'),
  notifications: ()=>db.collection('notifications')
};

/* Utils */
function esc(s){ return String(s ?? '').replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }
function escA(s){ return String(s ?? '').replace(/"/g,'&quot;'); }
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function daysBetween(iso){ if(!iso) return Infinity; const d = Math.floor((Date.now()-new Date(iso).getTime())/86400000); return isNaN(d)?Infinity:d; }
function eff(level,last){ const stale = daysBetween(last)>90?1:0; return Math.max(0,(Number(level)||0)-stale); }
function authz(e){ return e>=3 }
function hue(e){ const h=Math.max(0,Math.min(120,e*24)); return `hsl(${h} 70% 50% / 0.28)`; }
function groupBy(arr,fn){ const m={}; for(const it of arr){ const k=fn(it); (m[k]||(m[k]=[])).push(it) } return m; }

/* Comprehensive Multi-Brand Repair Tasks Database */
const seedTasks=[
  // ===== CORE SAFETY & PROCESS =====
  {id:'T001',category:'Core',subcategory:'Safety/Process',name:'ESD compliance & safe workspace',tier:'1 - Swap-level',targetMins:3,qcChecks:3,tools:'ESD mat, strap',risk:'Low',description:'Set up ESD, verify ground, inspect tools.',sopUrl:'',team:'Both'},
  {id:'T002',category:'Core',subcategory:'Safety/Process',name:'Tool calibration & maintenance',tier:'1 - Swap-level',targetMins:10,qcChecks:5,tools:'Calibration kit',risk:'Low',description:'Check torque drivers, multimeters, hot air stations.',sopUrl:'',team:'Both'},
  {id:'T003',category:'Core',subcategory:'Safety/Process',name:'Workspace organization & cleanup',tier:'1 - Swap-level',targetMins:5,qcChecks:3,tools:'Cleaning supplies',risk:'Low',description:'Organize tools, clean workspace, dispose waste properly.',sopUrl:'',team:'Both'},
  
  // ===== IPHONE REPAIRS =====
  {id:'T010',category:'iPhone',subcategory:'Battery',name:'iPhone Battery replacement (no error)',tier:'2 - Advanced',targetMins:25,qcChecks:8,tools:'Diagnostic battery, torque driver',risk:'Low',description:'Use diagnostic battery/programmer where lawful; calibrate.',sopUrl:'',team:'PR'},
  {id:'T011',category:'iPhone',subcategory:'Battery',name:'iPhone Battery replacement (with error)',tier:'2 - Advanced',targetMins:35,qcChecks:10,tools:'Programmer, diagnostic battery',risk:'Medium',description:'Clear battery error codes; calibrate new battery.',sopUrl:'',team:'PR'},
  {id:'T012',category:'iPhone',subcategory:'Display',name:'iPhone Display replacement + True Tone',tier:'2 - Advanced',targetMins:30,qcChecks:10,tools:'Programmer',risk:'Low',description:'Restore True Tone, dust control.',sopUrl:'',team:'PR'},
  {id:'T013',category:'iPhone',subcategory:'Display',name:'iPhone Back glass replacement',tier:'2 - Advanced',targetMins:45,qcChecks:8,tools:'Heat mat, cards, laser',risk:'Medium',description:'Remove back glass; replace with new unit.',sopUrl:'',team:'PR'},
  {id:'T014',category:'iPhone',subcategory:'Camera',name:'iPhone Camera replacement',tier:'2 - Advanced',targetMins:35,qcChecks:8,tools:'Torque driver, camera tester',risk:'Medium',description:'Replace camera module; test all functions.',sopUrl:'',team:'PR'},
  {id:'T015',category:'iPhone',subcategory:'Camera',name:'iPhone Camera lens replacement',tier:'2 - Advanced',targetMins:20,qcChecks:5,tools:'Heat mat, cards',risk:'Low',description:'Replace cracked camera lens.',sopUrl:'',team:'PR'},
  {id:'T016',category:'iPhone',subcategory:'Charging',name:'iPhone Lightning port replacement',tier:'2 - Advanced',targetMins:30,qcChecks:6,tools:'Heat mat, cards',risk:'Medium',description:'Replace Lightning port assembly.',sopUrl:'',team:'PR'},
  {id:'T017',category:'iPhone',subcategory:'Audio',name:'iPhone Speaker replacement',tier:'2 - Advanced',targetMins:25,qcChecks:5,tools:'Torque driver, cards',risk:'Low',description:'Replace speaker assembly; test audio.',sopUrl:'',team:'PR'},
  {id:'T018',category:'iPhone',subcategory:'Audio',name:'iPhone Microphone replacement',tier:'2 - Advanced',targetMins:20,qcChecks:5,tools:'Torque driver, cards',risk:'Low',description:'Replace microphone assembly; test recording.',sopUrl:'',team:'PR'},
  {id:'T019',category:'iPhone',subcategory:'Logic Board',name:'iPhone Logic Board repair',tier:'3 - Board-level',targetMins:120,qcChecks:15,tools:'Microscope, hot air, multimeter',risk:'High',description:'Component-level repair; power management.',sopUrl:'',team:'PR'},
  {id:'T020',category:'iPhone',subcategory:'Logic Board',name:'iPhone Water damage repair',tier:'3 - Board-level',targetMins:90,qcChecks:12,tools:'Ultrasonic cleaner, microscope',risk:'High',description:'Clean corrosion; replace damaged components.',sopUrl:'',team:'PR'},
  
  // ===== SAMSUNG GALAXY REPAIRS =====
  {id:'T021',category:'Samsung Galaxy',subcategory:'Display',name:'Samsung AMOLED + FP calibration',tier:'2 - Advanced',targetMins:40,qcChecks:8,tools:'Service app/jig',risk:'Medium',description:'Replace AMOLED; run fingerprint calibration.',sopUrl:'',team:'TR'},
  {id:'T022',category:'Samsung Galaxy',subcategory:'Display',name:'Samsung Back glass replacement',tier:'2 - Advanced',targetMins:35,qcChecks:6,tools:'Heat mat, cards',risk:'Medium',description:'Remove back glass; replace with new unit.',sopUrl:'',team:'TR'},
  {id:'T023',category:'Samsung Galaxy',subcategory:'Battery',name:'Samsung Battery replacement',tier:'2 - Advanced',targetMins:30,qcChecks:6,tools:'Heat mat, cards',risk:'Medium',description:'Remove back glass; replace battery.',sopUrl:'',team:'TR'},
  {id:'T024',category:'Samsung Galaxy',subcategory:'Charging',name:'Samsung Charging port replacement',tier:'2 - Advanced',targetMins:25,qcChecks:5,tools:'Heat mat, cards',risk:'Low',description:'Replace USB-C port assembly.',sopUrl:'',team:'TR'},
  {id:'T025',category:'Samsung Galaxy',subcategory:'Camera',name:'Samsung Camera replacement',tier:'2 - Advanced',targetMins:30,qcChecks:6,tools:'Torque driver, cards',risk:'Medium',description:'Replace camera module; test all functions.',sopUrl:'',team:'TR'},
  {id:'T026',category:'Samsung Galaxy',subcategory:'Audio',name:'Samsung Speaker replacement',tier:'2 - Advanced',targetMins:20,qcChecks:4,tools:'Torque driver, cards',risk:'Low',description:'Replace speaker assembly; test audio.',sopUrl:'',team:'TR'},
  {id:'T027',category:'Samsung Galaxy',subcategory:'Logic Board',name:'Samsung Logic Board repair',tier:'3 - Board-level',targetMins:100,qcChecks:12,tools:'Microscope, hot air, multimeter',risk:'High',description:'Component-level repair; power management.',sopUrl:'',team:'TR'},
  
  // ===== IPAD REPAIRS =====
  {id:'T031',category:'iPad',subcategory:'Battery',name:'iPad Battery replacement',tier:'2 - Advanced',targetMins:40,qcChecks:8,tools:'Isopropyl, cards',risk:'Medium',description:'Remove screen safely; lift cells; reseal.',sopUrl:'',team:'PR'},
  {id:'T032',category:'iPad',subcategory:'Display',name:'iPad Display replacement',tier:'2 - Advanced',targetMins:45,qcChecks:10,tools:'Heat mat, suction cups',risk:'Medium',description:'Remove display; replace with new unit.',sopUrl:'',team:'PR'},
  {id:'T033',category:'iPad',subcategory:'Home Button',name:'iPad Home Button replacement',tier:'2 - Advanced',targetMins:30,qcChecks:6,tools:'Torque driver, adhesive',risk:'Low',description:'Replace home button; test Touch ID.',sopUrl:'',team:'PR'},
  {id:'T034',category:'iPad',subcategory:'Charging',name:'iPad Lightning port replacement',tier:'2 - Advanced',targetMins:35,qcChecks:6,tools:'Heat mat, cards',risk:'Medium',description:'Replace Lightning port assembly.',sopUrl:'',team:'PR'},
  {id:'T035',category:'iPad',subcategory:'Audio',name:'iPad Speaker replacement',tier:'2 - Advanced',targetMins:25,qcChecks:5,tools:'Torque driver, cards',risk:'Low',description:'Replace speaker assembly; test audio.',sopUrl:'',team:'PR'},
  {id:'T036',category:'iPad',subcategory:'Logic Board',name:'iPad Logic Board repair',tier:'3 - Board-level',targetMins:120,qcChecks:15,tools:'Microscope, hot air, multimeter',risk:'High',description:'Component-level repair; power management.',sopUrl:'',team:'PR'},
  
  // ===== MACBOOK REPAIRS =====
  {id:'T041',category:'MacBook',subcategory:'Keyboard',name:'MacBook Keyboard replacement',tier:'2 - Advanced',targetMins:120,qcChecks:10,tools:'Rivet kit, drivers',risk:'Medium',description:'Split top case; transfer rivets/screws; backlight check.',sopUrl:'',team:'PR'},
  {id:'T042',category:'MacBook',subcategory:'Display',name:'MacBook Display replacement',tier:'2 - Advanced',targetMins:90,qcChecks:8,tools:'Torque driver, adhesive',risk:'Medium',description:'Replace display assembly; test all functions.',sopUrl:'',team:'PR'},
  {id:'T043',category:'MacBook',subcategory:'Logic Board',name:'MacBook Logic Board repair',tier:'3 - Board-level',targetMins:180,qcChecks:20,tools:'Microscope, hot air, BGA rework',risk:'High',description:'Component-level repair; power management.',sopUrl:'',team:'PR'},
  {id:'T044',category:'MacBook',subcategory:'Power',name:'MacBook MagSafe port replacement',tier:'2 - Advanced',targetMins:60,qcChecks:8,tools:'Torque driver, cards',risk:'Medium',description:'Replace MagSafe port assembly.',sopUrl:'',team:'PR'},
  {id:'T045',category:'MacBook',subcategory:'Storage',name:'MacBook SSD replacement',tier:'2 - Advanced',targetMins:45,qcChecks:6,tools:'Torque driver, cards',risk:'Low',description:'Replace SSD; restore from backup.',sopUrl:'',team:'PR'},
  {id:'T046',category:'MacBook',subcategory:'Audio',name:'MacBook Speaker replacement',tier:'2 - Advanced',targetMins:40,qcChecks:6,tools:'Torque driver, cards',risk:'Low',description:'Replace speaker assembly; test audio.',sopUrl:'',team:'PR'},
  
  // ===== GAMING CONSOLE REPAIRS =====
  {id:'T060',category:'PlayStation',subcategory:'HDMI',name:'PlayStation HDMI port replacement',tier:'3 - Board-level',targetMins:75,qcChecks:10,tools:'Hot air, microscope',risk:'High',description:'Hot air + iron; pad repair; retimer check.',sopUrl:'',team:'TR'},
  {id:'T061',category:'PlayStation',subcategory:'Power',name:'PlayStation Power supply replacement',tier:'2 - Advanced',targetMins:30,qcChecks:6,tools:'Torque driver, cards',risk:'Medium',description:'Replace power supply unit.',sopUrl:'',team:'TR'},
  {id:'T062',category:'PlayStation',subcategory:'Storage',name:'PlayStation HDD/SSD replacement',tier:'2 - Advanced',targetMins:25,qcChecks:4,tools:'Torque driver, cards',risk:'Low',description:'Replace storage drive; reinstall OS.',sopUrl:'',team:'TR'},
  {id:'T063',category:'Xbox',subcategory:'HDMI',name:'Xbox HDMI port replacement',tier:'3 - Board-level',targetMins:75,qcChecks:10,tools:'Hot air, microscope',risk:'High',description:'Hot air + iron; pad repair; retimer check.',sopUrl:'',team:'TR'},
  {id:'T064',category:'Xbox',subcategory:'Power',name:'Xbox Power supply replacement',tier:'2 - Advanced',targetMins:30,qcChecks:6,tools:'Torque driver, cards',risk:'Medium',description:'Replace power supply unit.',sopUrl:'',team:'TR'},
  {id:'T065',category:'Xbox',subcategory:'Storage',name:'Xbox HDD/SSD replacement',tier:'2 - Advanced',targetMins:25,qcChecks:4,tools:'Torque driver, cards',risk:'Low',description:'Replace storage drive; reinstall OS.',sopUrl:'',team:'TR'},
  {id:'T066',category:'Nintendo Switch',subcategory:'Joy-Con',name:'Nintendo Switch Joy-Con repair',tier:'2 - Advanced',targetMins:45,qcChecks:8,tools:'Torque driver, ribbon cables',risk:'Medium',description:'Fix drift, replace buttons, test all functions.',sopUrl:'',team:'TR'},
  {id:'T067',category:'Nintendo Switch',subcategory:'Display',name:'Nintendo Switch Screen replacement',tier:'2 - Advanced',targetMins:40,qcChecks:6,tools:'Heat mat, cards',risk:'Medium',description:'Replace screen; test touch functionality.',sopUrl:'',team:'TR'},
  {id:'T068',category:'Nintendo Switch',subcategory:'Charging',name:'Nintendo Switch USB-C port replacement',tier:'2 - Advanced',targetMins:35,qcChecks:6,tools:'Heat mat, cards',risk:'Medium',description:'Replace USB-C port assembly.',sopUrl:'',team:'TR'},
  
  // ===== APPLE WATCH REPAIRS =====
  {id:'T070',category:'Apple Watch',subcategory:'Display',name:'Apple Watch Screen replacement',tier:'2 - Advanced',targetMins:45,qcChecks:8,tools:'Heat mat, clamps',risk:'Medium',description:'Heat separation; seal replacement; water test.',sopUrl:'',team:'PR'},
  {id:'T071',category:'Apple Watch',subcategory:'Battery',name:'Apple Watch Battery replacement',tier:'2 - Advanced',targetMins:35,qcChecks:6,tools:'Heat mat, cards',risk:'Medium',description:'Remove screen; replace battery; reseal.',sopUrl:'',team:'PR'},
  {id:'T072',category:'Apple Watch',subcategory:'Crown',name:'Apple Watch Digital Crown replacement',tier:'2 - Advanced',targetMins:30,qcChecks:6,tools:'Torque driver, cards',risk:'Medium',description:'Replace Digital Crown; test rotation and press.',sopUrl:'',team:'PR'},
  {id:'T073',category:'Apple Watch',subcategory:'Band',name:'Apple Watch Band replacement',tier:'1 - Swap-level',targetMins:5,qcChecks:2,tools:'Band tool',risk:'Low',description:'Replace watch band; test secure attachment.',sopUrl:'',team:'PR'},
  
  // ===== WINDOWS LAPTOP REPAIRS =====
  {id:'T052',category:'Windows Laptop',subcategory:'Power',name:'Laptop DC jack replacement',tier:'2 - Advanced',targetMins:45,qcChecks:6,tools:'Iron, wick, flux',risk:'Medium',description:'Desolder/solder jack; strain relief.',sopUrl:'',team:'TR'},
  {id:'T053',category:'Windows Laptop',subcategory:'Keyboard',name:'Laptop Keyboard replacement',tier:'2 - Advanced',targetMins:60,qcChecks:8,tools:'Torque driver, ribbon cables',risk:'Low',description:'Remove keyboard; replace with new unit.',sopUrl:'',team:'TR'},
  {id:'T054',category:'Windows Laptop',subcategory:'Display',name:'Laptop Display replacement',tier:'2 - Advanced',targetMins:50,qcChecks:6,tools:'Torque driver, adhesive',risk:'Low',description:'Replace display panel; test all functions.',sopUrl:'',team:'TR'},
  {id:'T055',category:'Windows Laptop',subcategory:'Storage',name:'Laptop HDD/SSD replacement',tier:'2 - Advanced',targetMins:30,qcChecks:4,tools:'Torque driver, cards',risk:'Low',description:'Replace storage drive; reinstall OS.',sopUrl:'',team:'TR'},
  {id:'T056',category:'Windows Laptop',subcategory:'Memory',name:'Laptop RAM replacement',tier:'1 - Swap-level',targetMins:15,qcChecks:3,tools:'Torque driver, cards',risk:'Low',description:'Replace RAM modules; test memory.',sopUrl:'',team:'TR'},
  {id:'T057',category:'Windows Laptop',subcategory:'Audio',name:'Laptop Speaker replacement',tier:'2 - Advanced',targetMins:35,qcChecks:5,tools:'Torque driver, cards',risk:'Low',description:'Replace speaker assembly; test audio.',sopUrl:'',team:'TR'},
  {id:'T058',category:'Windows Laptop',subcategory:'Logic Board',name:'Laptop Logic Board repair',tier:'3 - Board-level',targetMins:120,qcChecks:15,tools:'Microscope, hot air, multimeter',risk:'High',description:'Component-level repair; power management.',sopUrl:'',team:'TR'},
  
  // ===== ANDROID PHONE REPAIRS =====
  {id:'T080',category:'Android Phone',subcategory:'Display',name:'Android Display replacement',tier:'2 - Advanced',targetMins:35,qcChecks:6,tools:'Heat mat, cards',risk:'Medium',description:'Replace display assembly; test touch.',sopUrl:'',team:'TR'},
  {id:'T081',category:'Android Phone',subcategory:'Battery',name:'Android Battery replacement',tier:'2 - Advanced',targetMins:25,qcChecks:5,tools:'Heat mat, cards',risk:'Medium',description:'Remove back cover; replace battery.',sopUrl:'',team:'TR'},
  {id:'T082',category:'Android Phone',subcategory:'Charging',name:'Android USB-C port replacement',tier:'2 - Advanced',targetMins:20,qcChecks:4,tools:'Heat mat, cards',risk:'Low',description:'Replace USB-C port assembly.',sopUrl:'',team:'TR'},
  {id:'T083',category:'Android Phone',subcategory:'Camera',name:'Android Camera replacement',tier:'2 - Advanced',targetMins:25,qcChecks:5,tools:'Torque driver, cards',risk:'Medium',description:'Replace camera module; test all functions.',sopUrl:'',team:'TR'},
  {id:'T084',category:'Android Phone',subcategory:'Audio',name:'Android Speaker replacement',tier:'2 - Advanced',targetMins:20,qcChecks:4,tools:'Torque driver, cards',risk:'Low',description:'Replace speaker assembly; test audio.',sopUrl:'',team:'TR'},
  
  // ===== TABLET REPAIRS =====
  {id:'T090',category:'Tablet',subcategory:'Display',name:'Android Tablet Display replacement',tier:'2 - Advanced',targetMins:40,qcChecks:6,tools:'Heat mat, cards',risk:'Medium',description:'Replace display assembly; test touch.',sopUrl:'',team:'TR'},
  {id:'T091',category:'Tablet',subcategory:'Battery',name:'Android Tablet Battery replacement',tier:'2 - Advanced',targetMins:35,qcChecks:6,tools:'Heat mat, cards',risk:'Medium',description:'Remove back cover; replace battery.',sopUrl:'',team:'TR'},
  {id:'T092',category:'Tablet',subcategory:'Charging',name:'Android Tablet USB-C port replacement',tier:'2 - Advanced',targetMins:25,qcChecks:4,tools:'Heat mat, cards',risk:'Low',description:'Replace USB-C port assembly.',sopUrl:'',team:'TR'},
  
  // ===== SMARTWATCH REPAIRS =====
  {id:'T100',category:'Smartwatch',subcategory:'Display',name:'Android Smartwatch Screen replacement',tier:'2 - Advanced',targetMins:40,qcChecks:6,tools:'Heat mat, cards',risk:'Medium',description:'Replace screen; test touch functionality.',sopUrl:'',team:'TR'},
  {id:'T101',category:'Smartwatch',subcategory:'Battery',name:'Android Smartwatch Battery replacement',tier:'2 - Advanced',targetMins:30,qcChecks:5,tools:'Heat mat, cards',risk:'Medium',description:'Remove back cover; replace battery.',sopUrl:'',team:'TR'},
  {id:'T102',category:'Smartwatch',subcategory:'Band',name:'Smartwatch Band replacement',tier:'1 - Swap-level',targetMins:5,qcChecks:2,tools:'Band tool',risk:'Low',description:'Replace watch band; test secure attachment.',sopUrl:'',team:'TR'},
  
  // ===== SAFETY & ADVANCED =====
  {id:'T110',category:'Safety',subcategory:'Electrical',name:'Mains isolation & capacitor discharge',tier:'2 - Advanced',targetMins:15,qcChecks:5,tools:'Insulated tools, HV resistor',risk:'High',description:'LOTO; verify isolation; discharge HV caps.',sopUrl:'',team:'Both'},
  {id:'T111',category:'Safety',subcategory:'Chemical',name:'Battery disposal & recycling',tier:'1 - Swap-level',targetMins:10,qcChecks:3,tools:'Safety container, gloves',risk:'Medium',description:'Properly dispose of damaged batteries.',sopUrl:'',team:'Both'},
  {id:'T112',category:'Safety',subcategory:'Environmental',name:'Workspace ventilation & air quality',tier:'1 - Swap-level',targetMins:5,qcChecks:2,tools:'Air quality monitor',risk:'Low',description:'Check ventilation; monitor air quality.',sopUrl:'',team:'Both'},
  
  // ===== DIAGNOSTIC & TESTING =====
  {id:'T120',category:'Diagnostic',subcategory:'Software',name:'Device diagnostics & testing',tier:'1 - Swap-level',targetMins:15,qcChecks:5,tools:'Diagnostic software, cables',risk:'Low',description:'Run comprehensive device diagnostics.',sopUrl:'',team:'Both'},
  {id:'T121',category:'Diagnostic',subcategory:'Hardware',name:'Component testing & verification',tier:'2 - Advanced',targetMins:20,qcChecks:6,tools:'Multimeter, oscilloscope',risk:'Low',description:'Test individual components; verify functionality.',sopUrl:'',team:'Both'},
  {id:'T122',category:'Diagnostic',subcategory:'Performance',name:'Performance benchmarking',tier:'2 - Advanced',targetMins:25,qcChecks:8,tools:'Benchmark software, thermal camera',risk:'Low',description:'Run performance tests; check thermal behavior.',sopUrl:'',team:'Both'},
  
  // ===== DATA RECOVERY =====
  {id:'T130',category:'Data Recovery',subcategory:'Software',name:'Data backup & recovery',tier:'2 - Advanced',targetMins:60,qcChecks:10,tools:'Data recovery software, cables',risk:'Medium',description:'Backup data; recover from damaged devices.',sopUrl:'',team:'Both'},
  {id:'T131',category:'Data Recovery',subcategory:'Hardware',name:'Storage device repair',tier:'3 - Board-level',targetMins:90,qcChecks:12,tools:'Microscope, hot air, data recovery tools',risk:'High',description:'Repair damaged storage devices; recover data.',sopUrl:'',team:'Both'},
  
  // ===== CUSTOM & SPECIALIZED =====
  {id:'T140',category:'Custom',subcategory:'Modification',name:'Device modification & customization',tier:'3 - Board-level',targetMins:120,qcChecks:15,tools:'Custom tools, specialized equipment',risk:'High',description:'Custom modifications; specialized repairs.',sopUrl:'',team:'Both'},
  {id:'T141',category:'Custom',subcategory:'Prototype',name:'Prototype development & testing',tier:'3 - Board-level',targetMins:180,qcChecks:20,tools:'Prototyping tools, test equipment',risk:'High',description:'Develop and test new repair techniques.',sopUrl:'',team:'Both'},
];

/* State */
let state={ user:null, techs:[], tasks:[], assess:[], teams:[], notifications:[], selectedTeam:'all' };
let unsub={ techs:null, tasks:null, assess:null, teams:null, notifications:null };

/* App shell */
const app=document.getElementById('app');
function render(){
  app.innerHTML='';
  if(!state.user){
    const w=document.createElement('div'); w.className='center';
    w.innerHTML=`<div class="card" style="max-width:520px">
      <h1>PR/TR Workshop Training</h1>
      <p class="help">Sign in to continue. Data is stored locally.</p>
      <div class="grid g1" style="margin-top:12px">
        <div><label>Email</label><input id="email" type="email" placeholder="admin" value="admin"></div>
        <div><label>Password</label><input id="password" type="password" placeholder="••••••••" value="a123456"></div>
        <div class="row">
          <button class="btn primary" id="loginEmail">Sign in</button>
          <button class="btn" id="registerEmail">Create account</button>
        </div>
      </div>
    </div>`;
    const loginHandler = async () => {
      const em = document.getElementById('email').value.trim();
      const pw = document.getElementById('password').value;
      try { 
        await auth.signInWithEmailAndPassword(em, pw);
        render(); // Refresh the page after login
      }
      catch (err) { alert('Sign-in failed: ' + err.message); }
    };
    
    const registerHandler = async () => {
      const em = document.getElementById('email').value.trim();
      const pw = document.getElementById('password').value;
      try { 
        await auth.createUserWithEmailAndPassword(em, pw);
        render(); // Refresh the page after registration
      }
      catch (err) { alert('Register failed: ' + err.message); }
    };
    
    w.querySelector('#loginEmail').addEventListener('click', loginHandler);
    w.querySelector('#registerEmail').addEventListener('click', registerHandler);
    
    // Add Enter key support
    w.querySelector('#password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        loginHandler();
      }
    });
    w.querySelector('#email').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('password').focus();
      }
    });
    app.appendChild(w); return;
  }
  const head=document.createElement('div'); head.className='row';
  head.innerHTML=`<h1>PR/TR Workshop Training</h1>
    <span class="badge">Signed in as ${esc(state.user.displayName||state.user.email)}</span>
    <div class="spacer"></div>
    <select id="teamFilter" class="btn" style="margin-right:8px">
      <option value="all">All Teams</option>
      <option value="TR">TR Team</option>
      <option value="PR">PR Team</option>
    </select>
    <button class="btn" id="exportBtn">Export JSON</button>
    <button class="btn" id="seedBtn">Seed Tasks</button>
    <button class="btn ghost" id="signOutBtn">Sign out</button>
    <input id="importFile" type="file" accept="application/json" hidden/>
    <button class="btn" id="importBtn">Import JSON</button>`;
  head.querySelector('#signOutBtn').addEventListener('click', ()=>auth.signOut());
  head.querySelector('#exportBtn').addEventListener('click', exportJSON);
  head.querySelector('#importBtn').addEventListener('click', ()=>head.querySelector('#importFile').click());
  head.querySelector('#importFile').addEventListener('change', importJSON);
  head.querySelector('#seedBtn').addEventListener('click', seedCatalog);
  head.querySelector('#teamFilter').addEventListener('change', (e)=>{ state.selectedTeam=e.target.value; render(); });
  app.appendChild(head);

  const tabs=document.createElement('div'); tabs.className='tabs';
  tabs.innerHTML=`<button class='tab-btn active' data-tab='dash'>Dashboard</button>
    <button class='tab-btn' data-tab='teams'>Teams</button>
    <button class='tab-btn' data-tab='techs'>Technicians</button>
    <button class='tab-btn' data-tab='tasks'>Task Catalog</button>
    <button class='tab-btn' data-tab='assess'>Assessments</button>
    <button class='tab-btn' data-tab='matrix'>Matrix</button>`;
  app.appendChild(tabs);

  const sections = ['dash','teams','techs','tasks','assess','matrix'].reduce((m,t)=>{ const s=document.createElement('section'); s.id='tab-'+t; s.className='card'; if(t!=='dash') s.hidden=true; app.appendChild(s); m[t]=s; return m; },{});
  tabs.querySelectorAll('.tab-btn').forEach(btn=>btn.addEventListener('click',()=>{ tabs.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); ['dash','teams','techs','tasks','assess','matrix'].forEach(t=>sections[t].hidden=(t!==btn.dataset.tab)); show(btn.dataset.tab); }));
  show('dash');
}

/* Tab content */
function show(tab){ if(tab==='dash') renderDash(); if(tab==='teams') renderTeams(); if(tab==='techs') renderTechs(); if(tab==='tasks') renderTasks(); if(tab==='assess') renderAssess(); if(tab==='matrix') renderMatrix(); }

function renderDash(){
  const el=document.getElementById('tab-dash');
  const T=state.tasks, A=state.assess, X=state.selectedTeam==='all'?state.techs:state.techs.filter(t=>t.team===state.selectedTeam);
  const byTech = groupBy(A,a=>a.techId), byTask = groupBy(A,a=>a.taskId);
  const coverage = T.map(task=>{ const rows=(byTask[task.id]||[]), effs=rows.map(r=>eff(r.level,r.lastPerformed)); return {task, auth: effs.filter(e=>e>=3).length, avg: effs.length? (effs.reduce((a,b)=>a+b,0)/effs.length).toFixed(2):'0.00'}; });
  const pct = T.length ? Math.round(100*coverage.filter(c=>c.auth>=2).length/T.length) : 0;
  const avgAll = A.length? (A.map(a=>eff(a.level,a.lastPerformed)).reduce((a,b)=>a+b,0)/A.length).toFixed(2):'0.00';
  // Generate reminders
  const reminders = [];
  for(const tech of X){
    const rows = byTech[tech.id] || [];
    for(const assess of rows){
      const days = daysBetween(assess.lastPerformed);
      if(days > 90){
        reminders.push({type:'stale',tech:tech.name,task:state.tasks.find(t=>t.id===assess.taskId)?.name||assess.taskId,days});
      } else if(days > 60){
        reminders.push({type:'warning',tech:tech.name,task:state.tasks.find(t=>t.id===assess.taskId)?.name||assess.taskId,days});
      }
    }
  }
  
  el.innerHTML=`
    <div class="grid g4">
      <div class="card"><div class="help">Technicians</div><div class="kpi">${X.length}</div></div>
      <div class="card"><div class="help">Tasks</div><div class="kpi">${T.length}</div></div>
      <div class="card"><div class="help">Coverage ≥ 2 authorised</div><div class="kpi">${pct}%</div></div>
      <div class="card"><div class="help">Avg Effective</div><div class="kpi">${avgAll}</div></div>
    </div>
    <div class="grid g2" style="margin-top:12px">
      <div class="card">
        <h2>Technician KPIs</h2>
        <table class="table"><thead><tr><th>Tech</th><th>Team</th><th>Auth skills</th><th>Stale</th></tr></thead>
        <tbody>${
          X.map(t=>{
            const rows=(byTech[t.id]||[]);
            const effs=rows.map(r=>eff(r.level,r.lastPerformed));
            const auths=effs.filter(e=>e>=3).length;
            const stale=rows.filter(r=>daysBetween(r.lastPerformed)>90).length;
            return `<tr><td>${esc(t.name||'')}</td><td><span class="badge">${esc(t.team||'Unassigned')}</span></td><td>${auths}</td><td>${stale}</td></tr>`;
          }).join('')
        }</tbody>
        </table>
      </div>
      <div class="card">
        <h2>Training Reminders</h2>
        <div style="max-height:300px;overflow-y:auto">
          ${reminders.length === 0 ? '<p class="help">No reminders at this time.</p>' : 
            reminders.map(r=>`<div class="row" style="margin-bottom:8px;padding:8px;background:${r.type==='stale'?'var(--bad)':'var(--warn)'};border-radius:8px">
              <strong>${esc(r.tech)}</strong><br>
              <small>${esc(r.task)} - ${r.days} days since last practice</small>
            </div>`).join('')
          }
        </div>
      </div>
    </div>`;
}

function renderTeams(){
  const el=document.getElementById('tab-teams');
  el.innerHTML = `<div class='row'><h2>Teams</h2><div class='spacer'></div><button class='btn primary' id='addTeam'>Add Team</button></div><div id='list' class='grid g2'></div>`;
  el.querySelector('#addTeam').addEventListener('click', async()=>{ 
    try {
      await col.teams().add({id:uid(),name:'New Team',type:'TR',description:'',createdAt:new Date().toISOString()});
      alert('Team added successfully!');
    } catch (error) {
      alert('Error adding team: ' + error.message);
    }
  });
  const host=el.querySelector('#list'); host.innerHTML='';
  for(const t of state.teams){
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`
      <div class='grid g3'>
        <div><label>Team Name</label><input data-k='name' value='${escA(t.name||"")}'></div>
        <div><label>Type</label><select data-k='type'>${['TR','PR'].map(v=>`<option ${t.type===v?'selected':''}>${v}</option>`).join('')}</select></div>
        <div><label>Description</label><input data-k='description' value='${escA(t.description||"")}'></div>
      </div>
      <div class='row' style='margin-top:8px'><div class='spacer'></div><button class='btn danger' data-del>Delete</button></div>`;
    div.addEventListener('input', async e=>{ const k=e.target.dataset.k; if(!k) return; await col.teams().doc(t._id).update({[k]:e.target.value,updatedAt:new Date().toISOString()}); });
    div.querySelector('[data-del]').addEventListener('click', async()=>{ if(!confirm('Delete team?')) return; await col.teams().doc(t._id).delete(); });
    host.appendChild(div);
  }
}

function renderTechs(){
  const el=document.getElementById('tab-techs');
  el.innerHTML = `<div class='row'><h2>Technicians</h2><div class='spacer'></div><button class='btn primary' id='addTech'>Add Tech</button></div><div id='list' class='grid'></div>`;
  el.querySelector('#addTech').addEventListener('click', async()=>{ 
    try {
      await col.techs().add({id:uid(),name:'New Technician',team:'TR',location:'',role:'',notes:'',createdAt:new Date().toISOString()});
      alert('Technician added successfully!');
    } catch (error) {
      alert('Error adding technician: ' + error.message);
    }
  });
  const host=el.querySelector('#list'); host.innerHTML='';
  for(const t of state.techs){
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`
      <div class='grid g5'>
        <div><label>Name</label><input data-k='name' value='${escA(t.name||"")}'></div>
        <div><label>Team</label><select data-k='team'>${['TR','PR'].map(v=>`<option ${t.team===v?'selected':''}>${v}</option>`).join('')}</select></div>
        <div><label>Location</label><input data-k='location' value='${escA(t.location||"")}'></div>
        <div><label>Role/Grade</label><input data-k='role' value='${escA(t.role||"")}'></div>
        <div><label>Notes</label><input data-k='notes' value='${escA(t.notes||"")}'></div>
      </div>
      <div class='row' style='margin-top:8px'><div class='spacer'></div><button class='btn danger' data-del>Delete</button></div>`;
    div.addEventListener('input', async e=>{ const k=e.target.dataset.k; if(!k) return; await col.techs().doc(t._id).update({[k]:e.target.value,updatedAt:new Date().toISOString()}); });
    div.querySelector('[data-del]').addEventListener('click', async()=>{ if(!confirm('Delete tech and related assessments?')) return; await col.techs().doc(t._id).delete(); const snap=await col.assess().where('techId','==',t.id).get(); const b=db.batch(); snap.forEach(d=>b.delete(d.ref)); await b.commit();});
    host.appendChild(div);
  }
}

function renderTasks(){
  const el=document.getElementById('tab-tasks');
  el.innerHTML = `<div class='row'><h2>Task Catalog</h2><div class='spacer'></div><button class='btn' id='seed'>Seed tasks</button><button class='btn primary' id='addTask'>Add Task</button></div><div id='list' class='grid'></div>`;
  el.querySelector('#seed').addEventListener('click', seedCatalog);
  el.querySelector('#addTask').addEventListener('click', async()=>{ 
    try {
      await col.tasks().add({id:'T'+(Math.random()*100000|0),category:'Core',subcategory:'',name:'New Task',tier:'1 - Swap-level',risk:'Low',targetMins:0,qcChecks:0,tools:'',prerequisites:'',sopUrl:'',notes:'',createdAt:new Date().toISOString()});
      alert('Task added successfully!');
    } catch (error) {
      alert('Error adding task: ' + error.message);
    }
  });
  const host=el.querySelector('#list'); host.innerHTML='';
  for(const t of state.tasks){
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`
      <div class='grid g5'>
        <div><label>TaskID</label><input data-k='id' value='${escA(t.id)}'></div>
        <div><label>Category</label><input data-k='category' value='${escA(t.category||"")}'></div>
        <div><label>Subcategory</label><input data-k='subcategory' value='${escA(t.subcategory||"")}'></div>
        <div><label>Name</label><input data-k='name' value='${escA(t.name||"")}'></div>
        <div><label>Tier</label><select data-k='tier'>
          ${['1 - Swap-level','2 - Advanced','3 - Board-level'].map(v=>`<option ${t.tier===v?'selected':''}>${v}</option>`).join('')}
        </select></div>
      </div>
      <div class='grid g3' style='margin-top:8px'>
        <div><label>Target mins</label><input type='number' data-k='targetMins' value='${Number(t.targetMins||0)}'></div>
        <div><label># QC checks</label><input type='number' data-k='qcChecks' value='${Number(t.qcChecks||0)}'></div>
        <div><label>Risk</label><select data-k='risk'>${['Low','Medium','High'].map(v=>`<option ${t.risk===v?'selected':''}>${v}</option>`).join('')}</select></div>
      </div>
      <div class='grid g3' style='margin-top:8px'>
        <div><label>Required tools</label><input data-k='tools' value='${escA(t.tools||"")}'></div>
        <div><label>Prerequisites</label><input data-k='prerequisites' value='${escA(t.prerequisites||"")}'></div>
        <div><label>SOP/Video URL</label><input data-k='sopUrl' value='${escA(t.sopUrl||"")}'></div>
      </div>
      <div style='margin-top:8px'><label>Description</label><textarea data-k='description' rows='2'>${esc(t.description||"")}</textarea></div>
      <div class='row' style='margin-top:8px'><div class='spacer'></div><button class='btn danger' data-del>Delete</button></div>`;
    div.addEventListener('input', async e=>{ const k=e.target.dataset.k; if(!k) return; let v=e.target.value; if(['targetMins','qcChecks'].includes(k)) v=Number(v||0); await col.tasks().doc(t._id).update({[k]:v,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}); });
    div.querySelector('[data-del]').addEventListener('click', async()=>{ if(!confirm('Delete task and related assessments?')) return; await col.tasks().doc(t._id).delete(); const snap=await col.assess().where('taskId','==',t.id).get(); const b=db.batch(); snap.forEach(d=>b.delete(d.ref)); await b.commit(); });
    host.appendChild(div);
  }
}

function renderAssess(){
  const el=document.getElementById('tab-assess');
  el.innerHTML = `<div class='row'><h2>Assessments</h2><div class='spacer'></div><button class='btn primary' id='add'>Add Assessment</button></div><div id='list' class='grid'></div>`;
  el.querySelector('#add').addEventListener('click', async()=>{ const techId=state.techs[0]?.id||''; const taskId=state.tasks[0]?.id||''; await col.assess().add({techId,taskId,level:0,observed:0,supervised:0,unsupervisedPass90:0,rework90:0,avgTime:0,lastPerformed:'',assessedBy:state.user.displayName||state.user.email,assessmentDate:new Date().toISOString().slice(0,10),createdAt:firebase.firestore.FieldValue.serverTimestamp()}) });
  const host=el.querySelector('#list'); host.innerHTML='';
  for(const a of state.assess){
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`
      <div class='grid g5'>
        <div><label>Technician</label><select data-k='techId'>${state.techs.map(t=>`<option value='${t.id}' ${a.techId===t.id?'selected':''}>${esc(t.name||'')}</option>`).join('')}</select></div>
        <div><label>Task</label><select data-k='taskId'>${state.tasks.map(t=>`<option value='${t.id}' ${a.taskId===t.id?'selected':''}>${t.id} – ${esc(t.name||'')}</option>`).join('')}</select></div>
        <div><label>Level</label><select data-k='level'>${[0,1,2,3,4,5].map(l=>`<option ${Number(a.level)===l?'selected':''}>${l}</option>`).join('')}</select></div>
        <div><label>Last performed</label><input type='date' data-k='lastPerformed' value='${(a.lastPerformed||'').slice(0,10)}'></div>
        <div><label>Assessment date</label><input type='date' data-k='assessmentDate' value='${(a.assessmentDate||'').slice(0,10)}'></div>
      </div>
      <div class='grid g5' style='margin-top:8px'>
        <div><label>Observed</label><input type='number' data-k='observed' value='${Number(a.observed||0)}'></div>
        <div><label>Supervised</label><input type='number' data-k='supervised' value='${Number(a.supervised||0)}'></div>
        <div><label>Unsupervised passes (90d)</label><input type='number' data-k='unsupervisedPass90' value='${Number(a.unsupervisedPass90||0)}'></div>
        <div><label>Rework (90d)</label><input type='number' data-k='rework90' value='${Number(a.rework90||0)}'></div>
        <div><label>Avg time (min)</label><input type='number' data-k='avgTime' value='${Number(a.avgTime||0)}'></div>
      </div>
      <div class='row' style='margin-top:8px'>
        <span class='badge'>Effective: ${eff(a.level,a.lastPerformed)} ${authz(eff(a.level,a.lastPerformed))?'· Authorised':''}</span>
        <div class='spacer'></div><button class='btn danger' data-del>Delete</button>
      </div>`;
    div.addEventListener('input', async e=>{ const k=e.target.dataset.k; if(!k) return; let v=e.target.value; if(['observed','supervised','unsupervisedPass90','rework90','avgTime','level'].includes(k)) v=Number(v||0); await col.assess().doc(a._id).update({[k]:v,updatedAt:firebase.firestore.FieldValue.serverTimestamp()}); });
    div.querySelector('[data-del]').addEventListener('click', async()=>{ if(!confirm('Delete assessment?')) return; await col.assess().doc(a._id).delete(); });
    host.appendChild(div);
  }
}

function renderMatrix(){
  const el=document.getElementById('tab-matrix');
  const filteredTechs = state.selectedTeam==='all'?state.techs:state.techs.filter(t=>t.team===state.selectedTeam);
  const filteredTasks = state.selectedTeam==='all'?state.tasks:state.tasks.filter(t=>t.team===state.selectedTeam||t.team==='Both');
  
  let html='<div class="help" style="margin-bottom:8px">Heatmap shows Effective Level (0–5). Green = Authorized (≥3), Red = Stale (>90 days). Edit in Assessments.</div>';
  html+='<div style="overflow:auto;border:1px solid var(--border);border-radius:12px">';
  html+='<table class="table"><thead><tr><th>Technician</th><th>Team</th>';
  for(const task of filteredTasks) html+=`<th title="${esc(task.description)}">${task.id}<br><small>${esc(task.name)}</small></th>`;
  html+='</tr></thead><tbody>';
  for(const tech of filteredTechs){
    html+=`<tr><td><strong>${esc(tech.name||'')}</strong></td><td><span class="badge">${esc(tech.team||'Unassigned')}</span></td>`;
    for(const task of filteredTasks){
      const rows=state.assess.filter(a=>a.techId===tech.id && a.taskId===task.id).sort((a,b)=>new Date(b.assessmentDate||0)-new Date(a.assessmentDate||0));
      const a=rows[0]; const e=a? eff(a.level,a.lastPerformed):0;
      const isStale = a && daysBetween(a.lastPerformed)>90;
      const isAuthorized = e>=3;
      const cellClass = isStale ? 'danger' : (isAuthorized ? 'ok' : '');
      html+=`<td class="${cellClass}" title="Level: ${a?.level||0}, Last: ${a?.lastPerformed||'Never'}, Effective: ${e}"><span class='pill' style='background:${hue(e)}'></span>${e}</td>`;
    }
    html+='</tr>';
  }
  html+='</tbody></table></div>';
  el.innerHTML=html;
}

/* Actions */
async function exportJSON(){
  const data={ techs: state.techs.map(({_id,...x})=>x), tasks: state.tasks.map(({_id,...x})=>x), assess: state.assess.map(({_id,...x})=>x) };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='workshop_export.json'; a.click(); URL.revokeObjectURL(url);
}
function importJSON(ev){
  const f=ev.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=async()=>{
    try{
      const data=JSON.parse(String(r.result));
      const b=db.batch();
      if(Array.isArray(data.techs)){
        for(const t of data.techs){
          const q=await col.techs().where('id','==',t.id).limit(1).get();
          const ref=q.empty? col.techs().doc() : q.docs[0].ref;
          b.set(ref,{...t,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
        }
      }
      if(Array.isArray(data.tasks)){
        for(const t of data.tasks){
          const q=await col.tasks().where('id','==',t.id).limit(1).get();
          const ref=q.empty? col.tasks().doc() : q.docs[0].ref;
          b.set(ref,{...t,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
        }
      }
      await b.commit();
      if(Array.isArray(data.assess)){
        const chunks=(a,s)=>a.reduce((r,_,i)=>(i%s? r[r.length-1].push(a[i]) : r.push([a[i]]), r), []);
        for(const ch of chunks(data.assess,400)){
          const bb=db.batch();
          for(const a of ch) bb.set(col.assess().doc(), {...a, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
          await bb.commit();
        }
      }
      alert('Import complete');
    }catch(e){ alert('Import failed: '+e.message); }
  }; r.readAsText(f);
}
async function seedCatalog(){
  if(!confirm('Add starter catalog tasks?')) return;
  try {
  for(const t of seedTasks){
      // Check if task already exists
      const existing = localStorage.getItem(`tasks_${t.id}`);
      if (!existing) {
        await col.tasks().add({...t, createdAt: new Date().toISOString()});
      }
    }
    alert('Starter catalog added successfully!');
  } catch (error) {
    alert('Error adding tasks: ' + error.message);
  }
}

/* Listeners */
function attach(){
  if(unsub.techs) unsub.techs(); if(unsub.tasks) unsub.tasks(); if(unsub.assess) unsub.assess(); if(unsub.teams) unsub.teams();
  unsub.techs = col.techs().orderBy('name').onSnapshot(s=>{ state.techs = s.docs.map(d=>({_id:d.id, ...d.data()})); if(!document.getElementById('tab-techs').hidden) renderTechs(); renderDash(); renderMatrix(); });
  unsub.tasks = col.tasks().orderBy('id').onSnapshot(s=>{ state.tasks = s.docs.map(d=>({_id:d.id, ...d.data()})); if(!document.getElementById('tab-tasks').hidden) renderTasks(); renderDash(); renderMatrix(); });
  unsub.assess = col.assess().orderBy('assessmentDate','desc').onSnapshot(s=>{ state.assess = s.docs.map(d=>({_id:d.id, ...d.data()})); if(!document.getElementById('tab-assess').hidden) renderAssess(); renderDash(); renderMatrix(); });
  unsub.teams = col.teams().orderBy('name').onSnapshot(s=>{ state.teams = s.docs.map(d=>({_id:d.id, ...d.data()})); if(!document.getElementById('tab-teams').hidden) renderTeams(); });
}

auth.onAuthStateChanged(u=>{ state.user=u; if(u) attach(); render(); });
render();
</script>
</body>
</html>
